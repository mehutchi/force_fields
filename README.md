# force_fields
The goal of this project is to efficiently and with low user error create custom small-molecule AMOEBA force fields using the TINKER software.

## automatic_generate_tinker_v3.py
This code creates an AMOEBA force field (using Python to run TINKER, Gaussian, and Open Babel) from a small molecule input.

The Ponder group has a tutorial which instructs how to use their Tinker software to create a custom AMOEBA force field for any desired small molecule. This code automates that approximately 25-step tutorial into two "one-click" parts, with only one small intervention needed in-between to verify atoms of equivalent symmetry. 

## tinker_vs_openmm_FIXED.py

The goal of this project was to take the AMOEBA force fields generated by automatic_generate_tinker_v3.py and optimize their parameters using ForceBalance (FB). However, it is convenient for FB to carry the parameter opimization forward using funcationally identical AMOEBA and OpenMM force fields. This is due to the fact that some calculations are easier or just not present in one engine verses the other.

Peter Eastman from the OpenMM Project kindly provided a TINKER-OpenMM force field conversion code which I adjusted to our needs. Unfortunately, I encounted many pitfalls attempting to create an exact copy of the custom AMOEBA force fields within OpenMM. This code was created to troubleshoot the observed energy differences when comparing "identical" force fields in TINKER and OpenMM. The following python plots illustrate part of that troubleshooting process:

The first troubleshooting measure was to compare the atomic distance matrices in a trial molecular dynamics simulation using a Urea force field in both TINKER and OpenMM. The purpose was to check if any extreme geometry contributed to the energy differences displayed by the two force fields which should have appeared identical.

![urea_dist_matrix](https://github.com/mehutchi/force_fields/assets/20996215/db751d71-7303-4232-8ae2-cccb95724efc)

In this figure, the upper left is the distance matrix for the 0th frame in the trial MD simulation
for urea. Lower left is an average distance matrix of the 100 least energetically different MD
frames between AMOEBA-Tinker and AMOEBA-OpenMM. Before averaging, each frame
had the 0th difference matrix subtracted (to highlight deviation from the planar starting
point). Lower right is the same as lower left, except using the 100 most energetically different
MD frames. All distances in Ångstrom, redder color indicates a larger distance.

The distance matrix figure makes it clear that extreme geometry is not the cause of the energy difference. Urea's geometry only vaies slightly during the simulation following what is expected for its physical behavior.

The next plot (obtained from a different code) illustrates the frame-by-frame energy difference in kJ/mol of TINKER energy minus OpenMM energy.

![diff_vs_frame_totalE](https://github.com/mehutchi/force_fields/assets/20996215/b70bc041-2b25-465f-ae9a-45707e9fc88c)

This figure illustrates energy differences far too great for two supposedly equal force fields. The maximum differences between Tinker and OpenMM total energies eclipsed 20 kJ/mol, with a percent difference of up to 11%.

It was then found that the out-of-plane bonding energy between Tinker and OpenMM was in disagreement. This was difficult to uncover, because in early iterations of the Tinker force field the out-of-plane parameters were excluded and the capability of converting them to OpenMM was commented out of the conversion code. That, and the fact that the early, oft-referenced frames experienced no out-of-plane bending hid the issue for a time.

![diff_angle-inpaf_ALL](https://github.com/mehutchi/force_fields/assets/20996215/a1ebf2be-12b3-4a71-96c7-7d5013bc5cb8)

Tinker and OpenMM angle energy components in kJ/mol vs MD frame. The Tinker angle energy is in blue, and the OpenMM angle energy is split between angle (green)
and in-plane-angle-force (orange). 

The solution we found to this was to adjust the Python script used for testing OpenMM energies to remove the automatically generated out-of-plane-bending energies and re-insert them as traditional angle energies.

![diff_vs_frame_tot_E_FIXED](https://github.com/mehutchi/force_fields/assets/20996215/af60d030-aa89-48b5-8739-25672c9ecb12)

Tinker minus OpenMM total energy in kJ/mol vs MD frame after applying the OpenMM fix in the testing script. The magnitude of the energy differences matches the expected behavior of the two force fields.  The maximum energy differences are around ± 0.0006 kJ/mol with a percent difference of 0.0003%. This is an acceptable energy difference between AMOEBA-Tinker-urea and AMOEBA-OpenMM-urea for later FB usage.

This final plot shows the frame-by-frame energy differences for each energy component.

![diff_vs_frame_ALL_FIXED](https://github.com/mehutchi/force_fields/assets/20996215/98b0b6eb-089d-417a-95cb-ccc65cbdd74f)

## fb_parameter_adjust.py
This code prepares AMOEBA and OpenMM force field files for usage within ForceBalance (FB). FB is a force field optimizer and requires placement of certain keywords and information to identify targets.

To prepare force fields for usage in FB, this code first removes any existing FB keywords from the files, then the desired keywords are added in. Choice of keywords depends on the desired optimization targets for FB, ex: bond, angle, VDW, etc. 

## vib_mode_format_converter.py
This short code takes a Frequencies.dat file (calculated by Terachem vibrational frequencies calculation) and converts it into vdata.txt, a required ForceBalance input file.

The main obstacle is that Frequencies.dat stores the frequencies in columns, but vdata.txt needs them orgainized into rows.

## xyz_to_tinker.py
This short code converts a .xyz input file into a Tinker .txyz file using a reference with the same atom ordering. (Note that Tinker files often use the .xyz extension even though they differ from traditional XYZ files, but I've found it useful to include a 't' in the extension when using both to help distinguish them)

The .txyz file format uses the same coordinates as .xyz, except that it explicitly lists atom connectivity and requires labeling of atom types. Existing molecular file conversion software can easily convert .txyz to .xyz, but it is not as suited for converting in the opposite direction when using custom AMOEBA force fields with uniquely indexed atom types and classes.

Aside from a desired .xyz file to convert, a reference .txyz file with the correct atom classes and attachments is needed. Atom ordering must be respected for this to work, but is not an issue if the molecules are not manipulated than re-saved.
